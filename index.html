<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<title>SIS Live Audio</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  margin:0;
  background:#0d0d14;
  color:#fff;
  font-family:system-ui;
}
header{
  padding:15px;
  background:#12121c;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
button{
  background:#ff2d55;
  border:none;
  color:#fff;
  padding:10px 14px;
  border-radius:8px;
  font-size:14px;
}
#container{padding:15px}
#likes{font-size:18px;cursor:pointer}
#comments{
  position:fixed;
  bottom:0;
  width:100%;
  background:#12121c;
}
#comments input{
  width:80%;
  padding:10px;
  border:none;
  background:#1a1a26;
  color:white;
}
#comments button{width:20%}
#log{max-height:150px;overflow:auto;font-size:13px}
</style>
</head>

<body>

<header>
  <div>SIS üî¥ Live Audio</div>
  <div id="likes">‚ù§Ô∏è 0</div>
</header>

<div id="container">
  <button id="create">Cr√©er un live</button>
  <button id="join" style="display:none">Rejoindre</button>
  <p id="links"></p>
  <div id="log"></div>
</div>

<div id="comments">
  <input id="msg" placeholder="Commenter le live‚Ä¶">
  <button id="send">Envoyer</button>
</div>

<audio id="remoteAudio" autoplay></audio>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot } 
from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDHCqPBzhWNnXuBrLvfa4NqCFeOdIRy6UI",
  authDomain: "gandxo-analytics.firebaseapp.com",
  projectId: "gandxo-analytics",
  storageBucket: "gandxo-analytics.firebasestorage.app",
  messagingSenderId: "660347922907",
  appId: "1:660347922907:web:652a37718edae658561ffe"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const pc = new RTCPeerConnection();
const audio = document.getElementById("remoteAudio");
pc.ontrack = e => audio.srcObject = e.streams[0];

async function mic(){
  const s = await navigator.mediaDevices.getUserMedia({audio:true});
  s.getTracks().forEach(t=>pc.addTrack(t,s));
}

const params = new URLSearchParams(location.search);
const roomId = params.get("room");
const role = params.get("role") || "listener";

if(roomId) document.getElementById("join").style.display="inline-block";

document.getElementById("create").onclick = async ()=>{
  await mic();
  const ref = doc(db,"lives",crypto.randomUUID());
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  await setDoc(ref,{
    offer,
    likes:0,
    comments:[]
  });

  const base = location.origin+location.pathname;
  document.getElementById("links").innerHTML = `
  Public : ${base}?room=${ref.id}<br>
  Speaker : ${base}?room=${ref.id}&role=speaker
  `;

  onSnapshot(ref,s=>{
    if(s.data().answer && !pc.currentRemoteDescription){
      pc.setRemoteDescription(s.data().answer);
    }
  });
};

document.getElementById("join").onclick = async ()=>{
  if(role==="speaker") await mic();
  const ref = doc(db,"lives",roomId);
  const snap = await getDoc(ref);
  await pc.setRemoteDescription(snap.data().offer);
  const ans = await pc.createAnswer();
  await pc.setLocalDescription(ans);
  await updateDoc(ref,{answer:ans});

  onSnapshot(ref,s=>{
    document.getElementById("likes").innerText="‚ù§Ô∏è "+s.data().likes;
    document.getElementById("log").innerHTML =
      (s.data().comments||[]).map(c=>"<div>"+c+"</div>").join("");
  });
};

document.getElementById("likes").onclick = async ()=>{
  const ref = doc(db,"lives",roomId);
  const snap = await getDoc(ref);
  await updateDoc(ref,{likes:snap.data().likes+1});
};

document.getElementById("send").onclick = async ()=>{
  const ref = doc(db,"lives",roomId);
  const snap = await getDoc(ref);
  const txt = document.getElementById("msg").value;
  if(!txt) return;
  await updateDoc(ref,{
    comments:[...(snap.data().comments||[]),txt]
  });
  document.getElementById("msg").value="";
};
</script>

</body>
</html>