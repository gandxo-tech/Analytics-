<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SIS - Say It Safely</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 3em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .btn-primary { background: #667eea; color: white; }
        .btn-secondary { background: #f093fb; color: white; }
        .btn-danger { background: #f56565; color: white; }
        .btn-success { background: #48bb78; color: white; }
        .btn:hover { transform: translateY(-2px); opacity: 0.9; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .hidden { display: none !important; }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            background: #e2e8f0;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab-btn.active {
            background: #667eea;
            color: white;
        }

        .user-info {
            background: #f7fafc;
            padding: 15px;
            border-radius: 8px;
        }

        .user-info p { margin: 5px 0; }

        .action-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .lives-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .live-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .live-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .live-card h3 {
            color: #333;
            margin-bottom: 10px;
        }

        .live-card .status {
            display: inline-block;
            padding: 4px 12px;
            background: #48bb78;
            color: white;
            border-radius: 20px;
            font-size: 0.85em;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .live-card .status.waiting {
            background: #ed8936;
        }

        .live-interface {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .live-interface {
                grid-template-columns: 1fr;
            }
        }

        .audio-controls {
            text-align: center;
            padding: 40px 30px;
            background: linear-gradient(135deg, #f7fafc 0%, #e2e8f0 100%);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .audio-icon {
            font-size: 100px;
            margin-bottom: 20px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .audio-status {
            font-size: 1.5em;
            font-weight: 600;
            margin-bottom: 20px;
            color: #667eea;
        }

        .participants-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .participant-item {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
        }

        .participant-item:hover {
            background: #f7fafc;
        }

        .comments-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
        }

        .comments-list {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: #f7fafc;
            border-radius: 8px;
        }

        .comment-item {
            padding: 10px;
            margin-bottom: 8px;
            background: white;
            border-radius: 8px;
            border-left: 3px solid #667eea;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .comment-author {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 4px;
            font-size: 0.9em;
        }

        .comment-input {
            display: flex;
            gap: 10px;
        }

        .comment-input input { 
            flex: 1;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
        }

        .hearts-count {
            font-size: 2.5em;
            color: #f56565;
            text-align: center;
            margin: 20px 0;
            font-weight: 700;
        }

        #connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 20px;
            background: white;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-weight: 600;
            z-index: 1000;
        }

        .status-online { color: #48bb78; }
        .status-offline { color: #f56565; }

        .hand-raised {
            animation: wave 1s ease-in-out infinite;
        }

        @keyframes wave {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(20deg); }
            75% { transform: rotate(-20deg); }
        }

        .live-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: #f56565;
            color: white;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
            margin-left: 10px;
        }

        .live-indicator::before {
            content: '';
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
            animation: blink 1s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        small {
            color: #718096;
            font-size: 0.85em;
            display: block;
            margin-top: 5px;
        }

        .host-controls-card {
            margin-top: 20px;
        }

        .hand-request {
            padding: 15px;
            background: #fff5f5;
            border: 2px solid #feb2b2;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .hand-request p {
            margin-bottom: 10px;
            font-weight: 600;
        }

        .hand-request-buttons {
            display: flex;
            gap: 10px;
        }

        .viewer-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 4px 10px;
            background: #e2e8f0;
            border-radius: 15px;
            font-size: 0.9em;
        }
    </style>
</head>
<body>
    <div id="connection-status" class="hidden"></div>

    <div class="container">
        <header>
            <h1>üéôÔ∏è SIS</h1>
            <p>Say It Safely - Live Audio Anonyme</p>
        </header>

        <!-- ========================================== -->
        <!-- √âCRAN: AUTHENTIFICATION -->
        <!-- ========================================== -->
        <div id="auth-screen" class="card">
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchAuthTab('login')">Connexion</button>
                <button class="tab-btn" onclick="switchAuthTab('signup')">Inscription</button>
            </div>

            <!-- LOGIN -->
            <div id="login-tab">
                <h2 style="margin-bottom: 20px;">Connexion</h2>
                <form id="login-form">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="login-email" placeholder="exemple@email.com" required autocomplete="email">
                    </div>
                    <div class="form-group">
                        <label>Mot de passe</label>
                        <input type="password" id="login-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="current-password">
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">Se connecter</button>
                </form>
            </div>

            <!-- SIGNUP -->
            <div id="signup-tab" class="hidden">
                <h2 style="margin-bottom: 20px;">Inscription</h2>
                <form id="signup-form">
                    <div class="form-group">
                        <label>Pseudo</label>
                        <input type="text" id="signup-pseudo" placeholder="VoixLibre123" required maxlength="20" autocomplete="username">
                        <small>3-20 caract√®res : lettres, chiffres et underscore uniquement</small>
                    </div>
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="signup-email" placeholder="exemple@email.com" required autocomplete="email">
                    </div>
                    <div class="form-group">
                        <label>Mot de passe</label>
                        <input type="password" id="signup-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required minlength="6" autocomplete="new-password">
                        <small>Minimum 6 caract√®res</small>
                    </div>
                    <div class="form-group">
                        <label>Confirmer le mot de passe</label>
                        <input type="password" id="signup-password-confirm" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="new-password">
                    </div>
                    <button type="submit" class="btn btn-success" style="width: 100%;">Cr√©er un compte</button>
                </form>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- √âCRAN: ACCUEIL -->
        <!-- ========================================== -->
        <div id="home-screen" class="hidden">
            <div class="card user-info">
                <p>üë§ Pseudo: <strong id="user-pseudo">-</strong></p>
                <p>üìß Email: <strong id="user-email">-</strong></p>
                <p>‚≠ê Trust Score: <strong id="trust-score">0</strong></p>
                <p>üìä Lives h√©berg√©s: <strong id="lives-hosted">0</strong></p>
            </div>

            <div class="card">
                <h2 style="margin-bottom: 20px;">Actions</h2>
                <div class="action-buttons">
                    <button id="create-live-btn" class="btn btn-primary">üéôÔ∏è Cr√©er un Live</button>
                    <button id="logout-btn" class="btn btn-danger">üö™ D√©connexion</button>
                </div>
            </div>

            <div class="card">
                <h2 style="margin-bottom: 20px;">Lives en cours</h2>
                <div id="lives-grid" class="lives-grid">
                    <p style="text-align: center; color: #999;">Chargement...</p>
                </div>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- √âCRAN: CR√âER UN LIVE -->
        <!-- ========================================== -->
        <div id="create-live-screen" class="hidden">
            <div class="card">
                <h2 style="margin-bottom: 20px;">Cr√©er un nouveau Live</h2>
                <form id="create-live-form">
                    <div class="form-group">
                        <label>Titre du live</label>
                        <input type="text" id="live-title" placeholder="Ex: Discussion sur la musique africaine üéµ" required maxlength="100">
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="is-public" checked style="width: auto; margin-right: 8px;">
                            Live public (visible par tous)
                        </label>
                    </div>

                    <div class="form-group">
                        <label>Limite d'auditeurs</label>
                        <select id="max-listeners">
                            <option value="5">5 personnes</option>
                            <option value="10" selected>10 personnes (recommand√©)</option>
                            <option value="15">15 personnes (maximum)</option>
                        </select>
                        <small>‚ö†Ô∏è Au-del√† de 15 personnes, la qualit√© audio peut √™tre affect√©e</small>
                    </div>

                    <div class="action-buttons">
                        <button type="submit" class="btn btn-success">‚úÖ Cr√©er et D√©marrer</button>
                        <button type="button" id="cancel-create-btn" class="btn btn-secondary">‚ùå Annuler</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- ========================================== -->
        <!-- √âCRAN: LIVE EN COURS -->
        <!-- ========================================== -->
        <div id="live-screen" class="hidden">
            <div class="card">
                <!-- En-t√™te du live -->
                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; flex-wrap: wrap; gap: 15px;">
                    <div style="flex: 1; min-width: 250px;">
                        <h2 id="live-title-display" style="margin-bottom: 10px;">-</h2>
                        <p id="live-host-display" style="color: #666; margin-bottom: 10px;">-</p>
                        <div>
                            <span id="live-status-badge" class="live-indicator hidden">LIVE</span>
                            <span class="viewer-badge">üëÅÔ∏è <span id="viewer-count">0</span> spectateurs</span>
                        </div>
                    </div>
                    <button id="leave-live-btn" class="btn btn-danger">Quitter le Live</button>
                </div>

                <div class="live-interface">
                    <!-- Colonne principale -->
                    <div>
                        <!-- Contr√¥les audio -->
                        <div class="audio-controls">
                            <div class="audio-icon" id="audio-icon">üé§</div>
                            <div class="audio-status" id="audio-status">En attente...</div>
                            <div class="action-buttons">
                                <button id="toggle-mic-btn" class="btn btn-primary hidden">üé§ Mute</button>
                                <button id="raise-hand-btn" class="btn btn-secondary hidden">‚úã Demander la parole</button>
                                <button id="start-live-btn" class="btn btn-success hidden">‚ñ∂Ô∏è D√©marrer le Live</button>
                            </div>
                        </div>

                        <!-- Hearts -->
                        <div class="hearts-count">
                            ‚ù§Ô∏è <span id="hearts-total">0</span>
                        </div>
                        <div style="text-align: center; margin-bottom: 20px;">
                            <button id="send-heart-btn" class="btn btn-primary">Envoyer un ‚ù§Ô∏è</button>
                        </div>

                        <!-- Commentaires -->
                        <div class="comments-section">
                            <h3 style="margin-bottom: 15px;">üí¨ Commentaires</h3>
                            <div class="comments-list" id="comments-list">
                                <p style="text-align: center; color: #999;">Aucun commentaire</p>
                            </div>
                            <div class="comment-input">
                                <input type="text" id="comment-input" placeholder="√âcris un commentaire..." maxlength="200">
                                <button id="send-comment-btn" class="btn btn-primary">Envoyer</button>
                            </div>
                        </div>
                    </div>

                    <!-- Colonne lat√©rale -->
                    <div>
                        <!-- Participants -->
                        <div class="card" style="padding: 20px;">
                            <h3 style="margin-bottom: 15px;">üë• Participants (<span id="participants-count">0</span>)</h3>
                            <div class="participants-list" id="participants-list">
                                <p style="text-align: center; color: #999;">Chargement...</p>
                            </div>
                        </div>

                        <!-- Contr√¥les h√¥te -->
                        <div id="host-controls" class="card host-controls-card hidden" style="padding: 20px;">
                            <h3 style="margin-bottom: 15px;">‚öôÔ∏è Contr√¥les H√¥te</h3>
                            <div id="hand-raised-list">
                                <p style="text-align: center; color: #999;">Aucune demande</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // ============================================
        // CONFIGURATION FIREBASE
        // ============================================
        
const firebaseConfig = {
            apiKey: "AIzaSyDHCqPBzhWNnXuBrLvfa4NqCFeOdIRy6UI",
            authDomain: "gandxo-analytics.firebaseapp.com",
            projectId: "gandxo-analytics",
            storageBucket: "gandxo-analytics.firebasestorage.app",
            messagingSenderId: "660347922907",
            appId: "1:660347922907:web:652a37718edae658561ffe"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let currentUser = null;
        let currentLiveId = null;
        let currentRole = null; // 'host', 'speaker', 'listener'
        let peerConnections = {};
        let localStream = null;
        let remoteStreams = {};
        let unsubscribers = [];
        let lastCommentTime = 0;
        let lastHeartTime = 0;

        const rtcConfig = {
            iceServers: [
                { urls: 'stun:stun.l.google.com:19302' },
                { urls: 'stun:stun1.l.google.com:19302' },
                { urls: 'stun:stun2.l.google.com:19302' },
                { urls: 'stun:stun3.l.google.com:19302' }
            ]
        };

        // ============================================
        // NAVIGATION ENTRE √âCRANS
        // ============================================
        function showScreen(screenId) {
            const screens = ['auth-screen', 'home-screen', 'create-live-screen', 'live-screen'];
            screens.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('hidden');
            });
            const target = document.getElementById(screenId);
            if (target) target.classList.remove('hidden');
        }

        window.switchAuthTab = function(tab) {
            const buttons = document.querySelectorAll('.tab-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            if (tab === 'login') {
                buttons[0].classList.add('active');
                document.getElementById('login-tab').classList.remove('hidden');
                document.getElementById('signup-tab').classList.add('hidden');
            } else {
                buttons[1].classList.add('active');
                document.getElementById('login-tab').classList.add('hidden');
                document.getElementById('signup-tab').classList.remove('hidden');
            }
        };

        // ============================================
        // AUTHENTIFICATION
        // ============================================

        // LOGIN
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value.trim();
            const password = document.getElementById('login-password').value;

            try {
                await auth.signInWithEmailAndPassword(email, password);
                console.log('‚úÖ Connexion r√©ussie');
            } catch (error) {
                console.error('‚ùå Erreur login:', error);
                alert('Erreur: ' + error.message);
            }
        });

        // SIGNUP
        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const pseudo = document.getElementById('signup-pseudo').value.trim();
            const email = document.getElementById('signup-email').value.trim();
            const password = document.getElementById('signup-password').value;
            const confirm = document.getElementById('signup-password-confirm').value;

            // Validation pseudo
            if (!/^[a-zA-Z0-9_]{3,20}$/.test(pseudo)) {
                alert('‚ùå Pseudo invalide ! (3-20 caract√®res, lettres/chiffres/underscore uniquement)');
                return;
            }

            // Validation mots de passe
            if (password !== confirm) {
                alert('‚ùå Les mots de passe ne correspondent pas');
                return;
            }

            if (password.length < 6) {
                alert('‚ùå Le mot de passe doit contenir au moins 6 caract√®res');
                return;
            }

            try {
                const userCredential = await auth.createUserWithEmailAndPassword(email, password);
                const userId = userCredential.user.uid;

                await db.collection('users').doc(userId).set({
                    userId: userId,
                    pseudo: pseudo,
                    email: email,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    trustScore: 0,
                    totalLivesHosted: 0,
                    totalLivesAttended: 0,
                    isBanned: false
                });

                console.log('‚úÖ Compte cr√©√©:', pseudo);
                alert('‚úÖ Compte cr√©√© avec succ√®s !');
            } catch (error) {
                console.error('‚ùå Erreur signup:', error);
                alert('Erreur: ' + error.message);
            }
        });

        // AUTH STATE CHANGED
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                currentUser = user;
                console.log('‚úÖ Utilisateur connect√©:', user.uid);
                
                const userDoc = await db.collection('users').doc(user.uid).get();
                
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    document.getElementById('user-pseudo').textContent = userData.pseudo;
                    document.getElementById('user-email').textContent = user.email;
                    document.getElementById('trust-score').textContent = userData.trustScore || 0;
                    document.getElementById('lives-hosted').textContent = userData.totalLivesHosted || 0;
                    
                    showScreen('home-screen');
                    loadPublicLives();
                }
            } else {
                currentUser = null;
                console.log('‚ÑπÔ∏è Aucun utilisateur connect√©');
                showScreen('auth-screen');
            }
        });

        // LOGOUT
        document.getElementById('logout-btn').addEventListener('click', async () => {
            if (confirm('Se d√©connecter ?')) {
                await auth.signOut();
            }
        });

        // ============================================
        // CR√âATION DE LIVE
        // ============================================
        document.getElementById('create-live-btn').addEventListener('click', () => {
            showScreen('create-live-screen');
        });

        document.getElementById('cancel-create-btn').addEventListener('click', () => {
            showScreen('home-screen');
        });

        document.getElementById('create-live-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const title = document.getElementById('live-title').value.trim();
            const isPublic = document.getElementById('is-public').checked;
            const maxListeners = parseInt(document.getElementById('max-listeners').value);

            if (!currentUser) {
                alert('‚ùå Erreur: utilisateur non connect√©');
                return;
            }

            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                const userData = userDoc.data();

                console.log('üìù Cr√©ation du live...');

                const liveRef = await db.collection('lives').add({
                    hostId: currentUser.uid,
                    hostPseudo: userData.pseudo,
                    title: title,
                    isPublic: isPublic,
                    maxListeners: maxListeners,
                    status: 'waiting',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    startedAt: null,
                    endedAt: null,
                    currentListeners: 0,
                    currentSpeakers: [currentUser.uid],
                    totalHearts: 0
                });

                await db.collection('users').doc(currentUser.uid).update({
                    totalLivesHosted: firebase.firestore.FieldValue.increment(1)
                });

                console.log('‚úÖ Live cr√©√©:', liveRef.id);

                joinLiveRoom(liveRef.id, 'host');

            } catch (error) {
                console.error('‚ùå Erreur cr√©ation live:', error);
                alert('Erreur: ' + error.message);
            }
        });

        // ============================================
        // LISTE DES LIVES PUBLICS
        // ============================================
        function loadPublicLives() {
            console.log('üì° Chargement des lives publics...');

            const unsub = db.collection('lives')
                .where('isPublic', '==', true)
                .where('status', 'in', ['waiting', 'live'])
                .orderBy('createdAt', 'desc')
                .limit(20)
                .onSnapshot(snapshot => {
                    const grid = document.getElementById('lives-grid');
                    grid.innerHTML = '';

                    if (snapshot.empty) {
                        grid.innerHTML = '<p style="text-align: center; color: #999;">Aucun live en cours</p>';
                        return;
                    }

                    console.log(`‚úÖ ${snapshot.size} live(s) trouv√©(s)`);

                    snapshot.forEach(doc => {
                        const live = doc.data();
                        const isFull = live.maxListeners && live.currentListeners >= live.maxListeners;
                        
                        const card = document.createElement('div');
                        card.className = 'live-card';
                        
                        const statusClass = live.status === 'live' ? 'status' : 'status waiting';
                        const statusText = live.status === 'live' ? 'üî¥ EN DIRECT' : '‚è≥ En attente';
                        
                        
card.innerHTML = `
                            <div class="${statusClass}">${statusText}</div>
                            <h3>${live.title}</h3>
                            <p style="margin: 8px 0;"><strong>H√¥te:</strong> ${live.hostPseudo}</p>
                            <p style="margin: 8px 0;">üëÅÔ∏è ${live.currentListeners || 0} / ${live.maxListeners} spectateurs</p>
                            <p style="margin: 8px 0;">‚ù§Ô∏è ${live.totalHearts || 0} hearts</p>
                            ${isFull ? '<p style="color: red; font-weight: 600;">COMPLET</p>' : ''}
                            <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" 
                                    ${isFull ? 'disabled' : ''} 
                                    onclick="joinLiveRoom('${doc.id}', 'listener')">
                                ${isFull ? 'üö´ Complet' : 'üéß Rejoindre'}
                            </button>
                        `;
                        
                        grid.appendChild(card);
                    });
                }, error => {
                    console.error('‚ùå Erreur chargement lives:', error);
                });

            unsubscribers.push(unsub);
        }

        // ============================================
        // REJOINDRE UN LIVE
        // ============================================
        window.joinLiveRoom = async function(liveId, role) {
            currentLiveId = liveId;
            currentRole = role;

            console.log(`üö™ Rejoindre le live ${liveId} en tant que ${role}`);

            try {
                // V√©rifier que le live existe
                const liveDoc = await db.collection('lives').doc(liveId).get();
                
                if (!liveDoc.exists) {
                    alert('‚ùå Live introuvable');
                    return;
                }

                const liveData = liveDoc.data();

                // V√©rifier si le live est complet
                if (role === 'listener' && liveData.maxListeners) {
                    if (liveData.currentListeners >= liveData.maxListeners) {
                        alert('‚ùå Ce live est complet');
                        return;
                    }
                }

                // Afficher l'√©cran du live
                showScreen('live-screen');
                
                // Remplir les informations
                document.getElementById('live-title-display').textContent = liveData.title;
                document.getElementById('live-host-display').textContent = `H√¥te: ${liveData.hostPseudo}`;
                document.getElementById('viewer-count').textContent = liveData.currentListeners || 0;

                if (liveData.status === 'live') {
                    document.getElementById('live-status-badge').classList.remove('hidden');
                    document.getElementById('audio-status').textContent = 'üî¥ EN DIRECT';
                    document.getElementById('audio-icon').textContent = 'üî¥';
                }

                // Ajouter l'utilisateur comme participant
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                const userData = userDoc.data();

                await db.collection('lives').doc(liveId).collection('participants').doc(currentUser.uid).set({
                    userId: currentUser.uid,
                    pseudo: userData.pseudo,
                    role: role,
                    joinedAt: firebase.firestore.FieldValue.serverTimestamp(),
                    handRaised: false,
                    isMuted: false
                });

                // Incr√©menter le compteur de spectateurs
                await db.collection('lives').doc(liveId).update({
                    currentListeners: firebase.firestore.FieldValue.increment(1)
                });

                // Incr√©menter le compteur utilisateur
                await db.collection('users').doc(currentUser.uid).update({
                    totalLivesAttended: firebase.firestore.FieldValue.increment(1)
                });

                // Afficher les bons contr√¥les selon le r√¥le
                if (role === 'host') {
                    console.log('üëë Mode H√¥te activ√©');
                    document.getElementById('start-live-btn').classList.remove('hidden');
                    document.getElementById('toggle-mic-btn').classList.remove('hidden');
                    document.getElementById('host-controls').classList.remove('hidden');
                    await setupLocalAudio();
                } else if (role === 'speaker') {
                    console.log('üé§ Mode Speaker activ√©');
                    document.getElementById('toggle-mic-btn').classList.remove('hidden');
                    await setupLocalAudio();
                } else {
                    console.log('üë§ Mode Listener activ√©');
                    document.getElementById('raise-hand-btn').classList.remove('hidden');
                }

                // Configurer les listeners en temps r√©el
                setupLiveListeners(liveId);

                // IMPORTANT: Connecter automatiquement aux speakers si on est listener
                if (role === 'listener') {
                    setTimeout(() => {
                        console.log('üîó Connexion automatique aux speakers...');
                        connectToExistingSpeakers();
                    }, 1500);
                }

                // IMPORTANT: Connecter automatiquement aux listeners si on est speaker/host
                if (role === 'host' || role === 'speaker') {
                    setTimeout(() => {
                        console.log('üîó Connexion automatique aux listeners...');
                        connectToExistingListeners();
                    }, 2000);
                }

            } catch (error) {
                console.error('‚ùå Erreur join live:', error);
                alert('Erreur: ' + error.message);
                showScreen('home-screen');
            }
        };

        // ============================================
        // SETUP AUDIO LOCAL (MICRO)
        // ============================================
        async function setupLocalAudio() {
            try {
                console.log('üé§ Demande acc√®s micro...');
                
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    } 
                });
                
                console.log('‚úÖ Micro activ√©');
                
                document.getElementById('audio-status').textContent = 'üé§ Micro activ√©';
                document.getElementById('audio-icon').textContent = 'üé§';

            } catch (error) {
                console.error('‚ùå Erreur acc√®s micro:', error);
                alert('‚ùå Impossible d\'acc√©der au microphone. V√©rifie les permissions.');
            }
        }

        // ============================================
        // CONNEXION AUTO: LISTENER ‚Üí SPEAKERS
        // ============================================
        async function connectToExistingSpeakers() {
            console.log('üîç Recherche des speakers existants...');
            
            const snapshot = await db.collection('lives').doc(currentLiveId).collection('participants')
                .where('role', 'in', ['host', 'speaker'])
                .get();
            
            console.log(`‚úÖ ${snapshot.size} speaker(s) trouv√©(s)`);
            
            snapshot.forEach(doc => {
                const participant = doc.data();
                if (participant.userId !== currentUser.uid) {
                    console.log(`üîó Connexion au speaker: ${participant.pseudo}`);
                    createPeerConnection(participant.userId);
                }
            });
        }

        // ============================================
        // CONNEXION AUTO: SPEAKER ‚Üí LISTENERS
        // ============================================
        async function connectToExistingListeners() {
            console.log('üîç Recherche des listeners existants...');
            
            const snapshot = await db.collection('lives').doc(currentLiveId).collection('participants')
                .where('role', '==', 'listener')
                .get();
            
            console.log(`‚úÖ ${snapshot.size} listener(s) trouv√©(s)`);
            
            snapshot.forEach(doc => {
                const participant = doc.data();
                if (participant.userId !== currentUser.uid) {
                    console.log(`üîó Connexion au listener: ${participant.pseudo}`);
                    createPeerConnection(participant.userId);
                }
            });
        }

        // ============================================
        // WEBRTC: CR√âER PEER CONNECTION
        // ============================================
        async function createPeerConnection(remoteUserId) {
            if (peerConnections[remoteUserId]) {
                console.log(`‚ö†Ô∏è Connexion d√©j√† existante avec ${remoteUserId}`);
                return;
            }

            console.log(`üì° Cr√©ation PeerConnection avec ${remoteUserId}`);

            const pc = new RTCPeerConnection(rtcConfig);
            peerConnections[remoteUserId] = pc;

            // SPEAKER/HOST envoie son audio
            if ((currentRole === 'host' || currentRole === 'speaker') && localStream) {
                localStream.getTracks().forEach(track => {
                    pc.addTrack(track, localStream);
                    console.log(`üéµ Track audio ajout√© pour ${remoteUserId}`);
                });
            }

            // LISTENER re√ßoit l'audio
            pc.ontrack = (event) => {
                console.log(`üéµ Audio re√ßu de ${remoteUserId}`);
                remoteStreams[remoteUserId] = event.streams[0];
                playRemoteAudio(event.streams[0], remoteUserId);
            };

            // ICE candidates
            pc.onicecandidate = (event) => {
                if (event.candidate) {
                    db.collection('lives').doc(currentLiveId).collection('signals').add({
                        from: currentUser.uid,
                        to: remoteUserId,
                        type: 'ice-candidate',
                        candidate: event.candidate.toJSON(),
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    }).catch(err => console.error('‚ùå Erreur envoi ICE:', err));
                }
            };

            pc.onconnectionstatechange = () => {
                console.log(`üîó √âtat connexion avec ${remoteUserId}:`, pc.connectionState);
                updateConnectionStatus();
            };

            // Cr√©er et envoyer l'offer
            try {
                const offer = await pc.createOffer();
                await pc.setLocalDescription(offer);

                await db.collection('lives').doc(currentLiveId).collection('signals').add({
                    from: currentUser.uid,
                    to: remoteUserId,
                    type: 'offer',
                    sdp: offer,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                console.log(`‚úÖ Offer envoy√©e √† ${remoteUserId}`);
            } catch (error) {
                console.error(`‚ùå Erreur cr√©ation offer pour ${remoteUserId}:`, error);
            }
        }

        // ============================================
        // WEBRTC: LECTURE AUDIO DISTANT
        // ============================================
        function playRemoteAudio(stream, userId) {
            let audio = document.getElementById(`audio-${userId}`);
            
            if (!audio) {
                audio = document.createElement('audio');
                audio.id = `audio-${userId}`;
                audio.autoplay = true;
                audio.controls = false;
                audio.volume = 1.0;
                document.body.appendChild(audio);
                console.log(`üîä √âl√©ment audio cr√©√© pour ${userId}`);
            }

            audio.srcObject = stream;
            
            audio.play()
                .then(() => {
                    console.log(`‚úÖ Audio en lecture pour ${userId}`);
                })
                .catch(error => {
                    console.error(`‚ùå Erreur lecture audio pour ${userId}:`, error);
                    
                    // Retry apr√®s interaction utilisateur
                    const retry = () => {
                        audio.play()
                            .then(() => console.log(`‚úÖ Retry r√©ussi pour ${userId}`))
                            .catch(err => console.error(`‚ùå Retry √©chou√©:`, err));
                        document.removeEventListener('click', retry);
                    };
                    
                    document.addEventListener('click', retry, { once: true });
                    alert('üîä Clique n\'importe o√π pour activer l\'audio');
                });
        }

        // ============================================
        // LISTENERS TEMPS R√âEL
        // ============================================
        function setupLiveListeners(liveId) {
            console.log('üì° Configuration des listeners temps r√©el...');

            // 1Ô∏è‚É£ SIGNALS (WebRTC signaling)
            const signalsUnsub = db.collection('lives').doc(liveId).collection('signals')
                .where('to', '==', currentUser.uid)
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            handleSignal(change.doc.data(), change.doc.id);
                        }
                    });
                });

            // 2Ô∏è‚É£ PARTICIPANTS
            const participantsUnsub = db.collection('lives').doc(liveId).collection('participants')
                .onSnapshot(snapshot => {
                    updateParticipantsList(snapshot);
                    
                    // D√©tecter nouveaux participants pour connexion auto
                    snapshot.docChanges().forEach(change => {
                        if (change.type === 'added') {
                            const participant = change.doc.data();
                            
                            if (participant.userId !== currentUser.uid) {
                                // Speaker/Host se connecte aux nouveaux listeners
                                if ((currentRole === 'host' || currentRole === 'speaker') && participant.role === 'listener') {
                                    setTimeout(() => {
                                        console.log(`üÜï Nouveau listener: ${participant.pseudo}`);
                                        createPeerConnection(participant.userId);
                                    }, 500);
                                }
                                
                                // Listener se connecte aux nouveaux speakers
                                if (currentRole === 'listener' && (participant.role === 'host' || participant.role === 'speaker')) {
                                    setTimeout(() => {
                                        console.log(`üÜï Nouveau speaker: ${participant.pseudo}`);
                                        createPeerConnection(participant.userId);
                                    }, 500);
                                }
                            }
                        }
                        
                        // D√©tecter changement listener ‚Üí speaker
                        if (change.type === 'modified') {
                            const participant = change.doc.data();
                            
                            if (participant.userId === currentUser.uid && participant.role === 'speaker' && currentRole === 'listener') {
                                console.log('üé§ Vous √™tes maintenant speaker !');
                                currentRole = 'speaker';
                                document.getElementById('raise-hand-btn').classList.add('hidden');
                                document.getElementById('toggle-mic-btn').classList.remove('hidden');
                                setupLocalAudio().then(() => {
                                    setTimeout(() => connectToExistingListeners(), 1000);
                                });
                            }
                        }
                    });
                });

            // 3Ô∏è‚É£ COMMENTAIRES
            const commentsUnsub = db.collection('lives').doc(liveId).collection('comments')
                .orderBy('timestamp', 'desc')
                .limit(50)
                .onSnapshot(snapshot => {
                    updateCommentsList(snapshot);
                });

            // 4Ô∏è‚É£ LIVE (hearts, status, etc.)
            const liveUnsub = db.collection('lives').doc(liveId)
                .onSnapshot(doc => {
                    const liveData = doc.data();
                    
                    document.getElementById('hearts-total').textContent = liveData.totalHearts || 0;
                    document.getElementById('participants-count').textContent = liveData.currentListeners || 0;
                    document.getElementById('viewer-count').textContent = liveData.currentListeners || 0;
                    
                    if (liveData.status === 'live') {
                        document.getElementById('live-status-badge').classList.remove('hidden');
                        document.getElementById('audio-status').textContent = 'üî¥ EN DIRECT';
                        document.getElementById('audio-icon').textContent = 'üî¥';
                    }
                    
                    if (liveData.status === 'ended') {
                        alert('Le live est termin√©');
                        leaveLive();
                    }
                });

            unsubscribers.push(signalsUnsub, participantsUnsub, commentsUnsub, liveUnsub);
            console.log('‚úÖ Listeners configur√©s');
        }

        // ============================================
        // WEBRTC: TRAITER SIGNAUX
        // ============================================
        async function handleSignal(signal, signalId) {
            const { from, type, sdp, candidate } = signal;

            console.log(`üì® Signal re√ßu: ${type} de ${from}`);

            let pc = peerConnections[from];

            try {
                if (type === 'offer') {
                    if (!pc) {
                        pc = new RTCPeerConnection(rtcConfig);
                        peerConnections[from] = pc;

                        // SPEAKER envoie son audio
                        if ((currentRole === 'host' || currentRole === 'speaker') && localStream) {
                            localStream.getTracks().forEach(track => {
                                pc.addTrack(track, localStream);
                            });
                        }
// Listenet
pc.ontrack = (event) => {
                            console.log(`üéµ Stream re√ßu de ${from}`);
                            remoteStreams[from] = event.streams[0];
                            playRemoteAudio(event.streams[0], from);
                        };

                        pc.onicecandidate = (event) => {
                            if (event.candidate) {
                                db.collection('lives').doc(currentLiveId).collection('signals').add({
                                    from: currentUser.uid,
                                    to: from,
                                    type: 'ice-candidate',
                                    candidate: event.candidate.toJSON(),
                                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                                }).catch(err => console.error('Erreur ICE:', err));
                            }
                        };

                        pc.onconnectionstatechange = () => {
                            console.log(`√âtat: ${pc.connectionState}`);
                            updateConnectionStatus();
                        };
                    }

                    await pc.setRemoteDescription(new RTCSessionDescription(sdp));
                    const answer = await pc.createAnswer();
                    await pc.setLocalDescription(answer);

                    await db.collection('lives').doc(currentLiveId).collection('signals').add({
                        from: currentUser.uid,
                        to: from,
                        type: 'answer',
                        sdp: answer,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    console.log(`‚úÖ Answer envoy√©e √† ${from}`);

                } else if (type === 'answer') {
                    if (pc) {
                        await pc.setRemoteDescription(new RTCSessionDescription(sdp));
                        console.log(`‚úÖ Answer trait√©e de ${from}`);
                    }
                } else if (type === 'ice-candidate') {
                    if (pc && candidate) {
                        await pc.addIceCandidate(new RTCIceCandidate(candidate));
                    }
                }

                // Supprimer le signal apr√®s traitement
                db.collection('lives').doc(currentLiveId).collection('signals').doc(signalId).delete().catch(() => {});

            } catch (error) {
                console.error(`‚ùå Erreur traitement signal ${type}:`, error);
            }
        }

        // ============================================
        // UI: MISE √Ä JOUR PARTICIPANTS
        // ============================================
        function updateParticipantsList(snapshot) {
            const list = document.getElementById('participants-list');
            const handsContainer = document.getElementById('hand-raised-list');
            
            list.innerHTML = '';
            handsContainer.innerHTML = '';

            const participants = [];
            const handsRaised = [];

            snapshot.forEach(doc => {
                const p = doc.data();
                participants.push(p);

                if (p.handRaised && currentRole === 'host') {
                    handsRaised.push(p);
                }
            });

            // Afficher participants
            if (participants.length === 0) {
                list.innerHTML = '<p style="text-align: center; color: #999;">Aucun participant</p>';
            } else {
                participants.forEach(p => {
                    const div = document.createElement('div');
                    div.className = 'participant-item';
                    
                    let icon = '';
                    if (p.role === 'host') icon = 'üëë';
                    else if (p.role === 'speaker') icon = 'üé§';
                    else icon = 'üë§';

                    div.innerHTML = `
                        <span>${icon} ${p.pseudo}</span>
                        ${p.handRaised ? '<span class="hand-raised" style="font-size: 1.5em;">‚úã</span>' : ''}
                    `;
                    
                    list.appendChild(div);
                });
            }

            // Afficher demandes de parole pour l'h√¥te
            if (currentRole === 'host') {
                if (handsRaised.length === 0) {
                    handsContainer.innerHTML = '<p style="text-align: center; color: #999;">Aucune demande</p>';
                } else {
                    handsRaised.forEach(p => {
                        const div = document.createElement('div');
                        div.className = 'hand-request';
                        div.innerHTML = `
                            <p>‚úã <strong>${p.pseudo}</strong> demande la parole</p>
                            <div class="hand-request-buttons">
                                <button class="btn btn-success" onclick="acceptSpeaker('${p.userId}')">‚úÖ Accepter</button>
                                <button class="btn btn-danger" onclick="rejectHand('${p.userId}')">‚ùå Refuser</button>
                            </div>
                        `;
                        handsContainer.appendChild(div);
                    });
                }
            }
        }

        // ============================================
        // H√îTE: ACCEPTER SPEAKER
        // ============================================
        window.acceptSpeaker = async function(userId) {
            console.log(`‚úÖ Accepter speaker: ${userId}`);
            
            try {
                await db.collection('lives').doc(currentLiveId).collection('participants').doc(userId).update({
                    role: 'speaker',
                    handRaised: false
                });

                await db.collection('lives').doc(currentLiveId).update({
                    currentSpeakers: firebase.firestore.FieldValue.arrayUnion(userId)
                });

                console.log('‚úÖ Speaker accept√©');
            } catch (error) {
                console.error('‚ùå Erreur accepter speaker:', error);
            }
        };

        // ============================================
        // H√îTE: REFUSER MAIN LEV√âE
        // ============================================
        window.rejectHand = async function(userId) {
            console.log(`‚ùå Refuser main: ${userId}`);
            
            try {
                await db.collection('lives').doc(currentLiveId).collection('participants').doc(userId).update({
                    handRaised: false
                });
            } catch (error) {
                console.error('‚ùå Erreur refuser main:', error);
            }
        };

        // ============================================
        // UI: MISE √Ä JOUR COMMENTAIRES
        // ============================================
        function updateCommentsList(snapshot) {
            const list = document.getElementById('comments-list');
            list.innerHTML = '';

            if (snapshot.empty) {
                list.innerHTML = '<p style="text-align: center; color: #999;">Aucun commentaire</p>';
                return;
            }

            snapshot.forEach(doc => {
                const comment = doc.data();
                const div = document.createElement('div');
                div.className = 'comment-item';
                div.innerHTML = `
                    <div class="comment-author">${comment.pseudo}</div>
                    <div>${comment.text}</div>
                `;
                list.appendChild(div);
            });

            list.scrollTop = list.scrollHeight;
        }

        // ============================================
        // COMMENTAIRES: ENVOYER
        // ============================================
        document.getElementById('send-comment-btn').addEventListener('click', sendComment);
        document.getElementById('comment-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') sendComment();
        });

        async function sendComment() {
            const input = document.getElementById('comment-input');
            const text = input.value.trim();

            if (!text) return;

            const now = Date.now();
            if (now - lastCommentTime < 3000) {
                alert('‚è±Ô∏è Attends 3 secondes entre chaque commentaire');
                return;
            }

            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                const userData = userDoc.data();

                await db.collection('lives').doc(currentLiveId).collection('comments').add({
                    userId: currentUser.uid,
                    pseudo: userData.pseudo,
                    text: text,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });

                input.value = '';
                lastCommentTime = now;
                console.log('‚úÖ Commentaire envoy√©');

            } catch (error) {
                console.error('‚ùå Erreur envoi commentaire:', error);
            }
        }

        // ============================================
        // HEARTS: ENVOYER
        // ============================================
        document.getElementById('send-heart-btn').addEventListener('click', async () => {
            const now = Date.now();
            if (now - lastHeartTime < 1000) return;

            try {
                await db.collection('lives').doc(currentLiveId).update({
                    totalHearts: firebase.firestore.FieldValue.increment(1)
                });

                lastHeartTime = now;

                const btn = document.getElementById('send-heart-btn');
                btn.style.transform = 'scale(1.3)';
                setTimeout(() => btn.style.transform = 'scale(1)', 200);

                console.log('‚ù§Ô∏è Heart envoy√©');

            } catch (error) {
                console.error('‚ùå Erreur envoi heart:', error);
            }
        });

        // ============================================
        // CONTR√îLES LIVE
        // ============================================

        // D√âMARRER LE LIVE (h√¥te uniquement)
        document.getElementById('start-live-btn').addEventListener('click', async () => {
            try {
                await db.collection('lives').doc(currentLiveId).update({
                    status: 'live',
                    startedAt: firebase.firestore.FieldValue.serverTimestamp()
                });

                document.getElementById('start-live-btn').classList.add('hidden');
                console.log('‚úÖ Live d√©marr√©');

            } catch (error) {
                console.error('‚ùå Erreur d√©marrage live:', error);
            }
        });

        // MUTE/UNMUTE MICRO
        let isMuted = false;
        document.getElementById('toggle-mic-btn').addEventListener('click', () => {
            if (!localStream) return;

            isMuted = !isMuted;
            localStream.getAudioTracks().forEach(track => {
                track.enabled = !isMuted;
            });

            const btn = document.getElementById('toggle-mic-btn');
            btn.textContent = isMuted ? 'üîá Unmute' : 'üé§ Mute';
            document.getElementById('audio-icon').textContent = isMuted ? 'üîá' : 'üé§';

            console.log(isMuted ? 'üîá Micro coup√©' : 'üé§ Micro activ√©');
        });

        // LEVER LA MAIN (listener uniquement)
        document.getElementById('raise-hand-btn').addEventListener('click', async () => {
            try {
                const doc = await db.collection('lives').doc(currentLiveId).collection('participants').doc(currentUser.uid).get();
                const currentHandRaised = doc.data().handRaised;

                await db.collection('lives').doc(currentLiveId).collection('participants').doc(currentUser.uid).update({
                    handRaised: !currentHandRaised
                });

                const btn = document.getElementById('raise-hand-btn');
                btn.textContent = !currentHandRaised ? '‚úã Main lev√©e' : '‚úã Demander la parole';

                console.log(!currentHandRaised ? '‚úã Main lev√©e' : 'üëã Main baiss√©e');

            } catch (error) {
                console.error('‚ùå Erreur lever main:', error);
            }
        });

        // QUITTER LE LIVE
        document.getElementById('leave-live-btn').addEventListener('click', () => {
            if (confirm('Quitter le live ?')) {
                leaveLive();
            }
        });

        async function leaveLive() {
            console.log('üëã Quitter le live...');

            try {
                // Fermer connexions WebRTC
                Object.values(peerConnections).forEach(pc => pc.close());
                peerConnections = {};

                // Arr√™ter stream local
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                    localStream = null;
                }

                // Supprimer √©l√©ments audio
                Object.keys(remoteStreams).forEach(userId => {
                    const audio = document.getElementById(`audio-${userId}`);
                    if (audio) audio.remove();
                });
                remoteStreams = {};

                // Supprimer de Firestore
                if (currentLiveId && currentUser) {
                    await db.collection('lives').doc(currentLiveId).collection('participants').doc(currentUser.uid).delete();

                    await db.collection('lives').doc(currentLiveId).update({
                        currentListeners: firebase.firestore.FieldValue.increment(-1)
                    });

                    // Si h√¥te, terminer le live
                    if (currentRole === 'host') {
                        await db.collection('lives').doc(currentLiveId).update({
                            status: 'ended',
                            endedAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    }
                }

                // D√©sabonner listeners
                unsubscribers.forEach(unsub => unsub());
                unsubscribers = [];

                currentLiveId = null;
                currentRole = null;

                showScreen('home-screen');
                console.log('‚úÖ Live quitt√©');

            } catch (error) {
                console.error('‚ùå Erreur leave live:', error);
                showScreen('home-screen');
            }
        }

        // ============================================
        // UI: STATUT CONNEXION
        // ============================================
        function updateConnectionStatus() {
            const statusDiv = document.getElementById('connection-status');
            const connected = Object.values(peerConnections).filter(
                pc => pc.connectionState === 'connected'
            ).length;

            if (connected > 0) {
                statusDiv.className = 'status-online';
                statusDiv.textContent